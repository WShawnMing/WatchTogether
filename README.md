# WatchTogether

一个面向异地情侣/朋友同看电影的桌面端 MVP，支持 `macOS` 和 `Windows`。

核心目标：

- 双方看到同一部电影
- 播放、暂停、拖动进度条可以实时同步
- 双方使用同一份视频源，避免一边清晰一边糊
- 网络卡顿时可以按策略处理，不让两边时间线越走越散

## 方案说明

这版不是让一方“投屏”给另一方，而是：

1. 双方先连接到同一个同步服务器
2. 房主创建房间并导入本地视频文件
3. 视频被上传到共享媒体服务
4. 双方播放器都从同一份视频文件做流式播放
5. 播放器操作和缓冲状态通过 Socket.IO 广播同步

这样做的优点：

- 两端拿到的是同一份源文件，画质一致
- 暂停、播放、拖动更容易精准同步
- 网络抖动时可以单独做追帧或全员暂停策略
- 更适合跨平台桌面端落地

## 当前实现

### 桌面端

- `Electron + React + Vite`
- 支持 `macOS / Windows` 打包
- 房间连接、成员状态、视频上传、同步播放器都在桌面端界面内完成

### 服务端

- `Express + Socket.IO`
- 负责房间管理、成员状态、同步广播
- 负责视频上传和 HTTP Range 流媒体分发

### 同步策略

- `柔性同步`
  - 默认模式
  - 某一端短时卡顿时，本地恢复后会尝试追平服务端时间线
- `严格同步`
  - 任一端进入缓冲，会暂停整个房间
  - 等双方都恢复，再从同一进度继续

### 网络抖动处理

- 服务端周期性广播播放状态，减少时间线漂移
- 客户端根据漂移量做两级修正
  - 小漂移：轻微调整 `playbackRate`
  - 大漂移：直接校正 `currentTime`
- 客户端在 `waiting / stalled / canplay / playing` 时上报缓冲状态
- Socket.IO 自带断线重连，重连后会自动重新加入房间并重新拉取最新播放状态

## 项目结构

```text
.
├── electron/          # Electron 主进程和 preload
├── server/            # 同步服务和媒体上传/分发
├── shared/            # 前后端共享协议
├── src/               # React 渲染层
└── package.json
```

## 本地开发

### 1. 安装依赖

```bash
npm install
```

### 2. 启动服务端 + 桌面端开发环境

```bash
npm run dev
```

默认端口：

- 前端/Electron 渲染：`5173`
- 服务端：`4000`

### 3. 使用方式

1. 一方点击“新建房间”
2. 把房间号发给另一方
3. 另一方输入同一个服务器地址和房间号后加入
4. 房主导入本地视频文件
5. 双方开始同步观看

## 构建

### 构建前端和服务端

```bash
npm run build
```

### 打包 macOS 客户端

```bash
npm run package:mac
```

### 打包 Windows 客户端

```bash
npm run package:win
```

## 服务端单独运行

```bash
npm run start:server
```

可选环境变量见 [.env.example](/Users/shawn_ming/workspace/watchtogether/.env.example)。

## 适合的部署方式

如果你和女朋友在不同网络环境下，推荐把服务端部署到一台公网机器：

- 云服务器
- 家里有公网入口的 NAS / 迷你主机
- 内网穿透后的固定入口

桌面端里把“同步服务器”改成对应地址即可。

## 已知限制

- 当前只支持两人房间
- 房主上传的是整部视频文件，超大文件会比较吃上行带宽
- 这版先聚焦“本地电影文件一起看”，还没有字幕轨、语音聊天、文件秒传、断点续传上传
- 服务端现在用本地磁盘存储上传视频，生产环境建议接对象存储或持久化卷

## 后续建议

适合继续往下做的版本迭代：

1. 增加字幕文件同步和双语字幕支持
2. 增加语音通话或房间内麦克风
3. 上传改为分片断点续传
4. 媒体服务改为对象存储 + CDN
5. 增加视频指纹校验，避免两端误看不同资源

## Git

仓库已经初始化为 Git 仓库，并在分支 `codex/watchtogether-mvp` 上进行开发。
