# WatchTogether

一个面向异地情侣/朋友同看电影的桌面端应用，支持 `macOS` 和 `Windows`。

这版按“同一局域网 / 虚拟局域网”场景设计，例如通过贝锐蒲公英、ZeroTier、Tailscale 等把两台电脑组到同一张虚拟局域网里。

## 目标

- 同网段内自动发现正在共享的房间
- 选择昵称后即可加入或发起共享
- 房主可设置可选密码
- 影片、播放、暂停、拖动、字幕同步
- 尽量保证双方画质一致
- 不依赖第三方中心中转服务器

## 当前架构

不是“把视频上传到公网服务器”，而是：

1. 房主点击“开始共享”
2. 应用在房主电脑上拉起本地直连服务
3. 主进程通过 UDP 广播向局域网宣布房间存在
4. 其他设备自动发现这个房间并选择加入
5. 房主导入本地视频与字幕文件
6. 对端直接从房主设备拉取视频流，播放状态由房主本机同步服务协调

这意味着：

- 没有第三方中间服务器
- 连接路径是“你 <-> 女朋友”直连到房主设备
- 片源保留在房主机器上
- 更适合虚拟局域网场景

## 技术实现

### 客户端

- `Electron + React + Vite`
- 同一套代码支持 `macOS / Windows`

### 房主本机直连服务

- `Express + Socket.IO`
- 运行在房主电脑本地，由 Electron 主进程内置启动
- 对端直接连房主地址，不需要额外部署公网服务

### 局域网发现

- Electron 主进程使用 UDP 广播做局域网房间发现
- 同网段设备会自动看到正在共享的房间
- 对于不转发广播的 VPN，后续可以再补高级直连入口

### 媒体分发

- 视频通过房主本机的 `HTTP Range` 接口提供
- 双方播放器都从同一份片源读取
- 另一方不是看“屏幕投屏”，而是直接拉取原视频流
- 字幕通过房主本机统一分发，当前支持 `.srt` 与 `.vtt`

### 同步策略

- `柔性同步`
  - 默认模式
  - 轻微漂移时通过微调播放速率追平
- `严格同步`
  - 任一端卡顿时暂停全房间
  - 双方恢复后再一起继续

## 使用方式

1. 双方先进入同一个局域网或虚拟局域网
2. 双方都打开应用并输入昵称
3. 房主点击“开始共享”，可选填写房间密码
4. 其他设备会在“附近正在共享”里看到这个房间
5. 点击“加入观看”
6. 房主选择影片；如有字幕，可再上传 `.srt` 或 `.vtt`

## 项目结构

```text
.
├── electron/          # Electron 主进程、preload、内置直连服务接入
├── server/            # 房主本机直连服务实现
├── shared/            # 前后端共享协议
├── src/               # React 渲染层
└── package.json
```

## 本地开发

### 安装依赖

```bash
npm install
```

### 启动桌面端开发环境

```bash
npm run dev
```

说明：

- 不再需要额外启动中心服务
- 房主点击 UI 中的“开始共享”即可
- 其他设备会自动发现房间

## 构建

### 构建桌面端和本地直连服务产物

```bash
npm run build
```

### 打包 macOS

```bash
npm run package:mac
```

### 打包 Windows

```bash
npm run package:win
```

## 可选：单独启动房主直连服务

主要用于开发或调试：

```bash
npm run start:server
```

默认监听 `4000` 端口。

## 网络前提

这版默认建立在下面这个前提之上：

- 双方已经通过局域网或虚拟局域网互通
- 双方可以直接访问对方机器的内网/VPN 地址

如果双方不在同一张可互通网络里，这版不会自动做 NAT 打洞或 TURN 中继。

## 当前限制

- 当前默认最多支持 `6` 人同房间
- 房主导入视频时，当前实现会复制一份到房主本机直连服务目录
- 对超大视频文件，房主本机磁盘和 IO 会有额外开销
- `mkv / avi / wmv` 已允许导入，但最终是否能播放取决于内置播放器是否支持对应编码
- 还没有语音通话、断点续传导入
- 还没有 NAT 穿透能力，前提是双方网络已经互通

## 下一步建议

1. 把“房主导入视频”从本地复制改成直接挂载源文件，减少磁盘占用
2. 增加房主网卡/分享地址选择器
3. 增加语音通话
4. 增加真正的 WebRTC 打洞模式，覆盖非局域网场景
5. 对高码率 `mkv` 做更稳妥的转封装或原生播放器接入

## Git

默认主分支是 `main`。
