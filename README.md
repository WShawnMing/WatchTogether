# WatchTogether

一个面向异地情侣/朋友同看电影的桌面端 MVP，支持 `macOS` 和 `Windows`。

这版按“同一局域网 / 虚拟局域网”场景设计，例如通过贝锐蒲公英、ZeroTier、Tailscale 等把两台电脑组到同一张虚拟局域网里。

## 目标

- 双方观看同一部电影
- 一方暂停、播放、拖动，另一方同步变化
- 尽量保证双方画质一致
- 网络抖动时避免进度线越走越散
- 不依赖第三方中心中转服务器

## 当前架构

不是“把视频上传到公网服务器”，而是：

1. 房主在自己的桌面端里启动“本机分享服务”
2. 应用在房主电脑上拉起一个本地直连服务
3. 另一方通过房主的 `VPN/LAN IP:端口` 直接连接
4. 房主导入本地视频文件
5. 对端直接从房主设备拉取视频流
6. 播放、暂停、拖动、缓冲状态通过房主本机上的同步服务协调

这意味着：

- 没有第三方中间服务器
- 连接路径是“你 <-> 女朋友”直连到房主设备
- 片源保留在房主机器上
- 更适合虚拟局域网场景

## 技术实现

### 客户端

- `Electron + React + Vite`
- 同一套代码支持 `macOS / Windows`

### 房主本机直连服务

- `Express + Socket.IO`
- 运行在房主电脑本地，由 Electron 主进程内置启动
- 对端直接连房主地址，不需要额外部署公网服务

### 媒体分发

- 视频通过房主本机的 `HTTP Range` 接口提供
- 双方播放器都从同一份片源读取
- 另一方不是看“屏幕投屏”，而是直接拉取原视频流

### 同步策略

- `柔性同步`
  - 默认模式
  - 轻微漂移时通过微调播放速率追平
- `严格同步`
  - 任一端卡顿时暂停全房间
  - 双方恢复后再一起继续

## 使用方式

### 房主

1. 先通过蒲公英等工具与对方进入同一虚拟局域网
2. 点击“启动本机分享并建房”
3. 复制应用生成的邀请串
4. 发给对方
5. 导入本地电影文件
6. 开始同步观看

### 另一方

1. 先与房主进入同一虚拟局域网
2. 打开应用，粘贴邀请串
3. 点击“解析邀请”
4. 点击“连接房主”

## 项目结构

```text
.
├── electron/          # Electron 主进程、preload、内置直连服务接入
├── server/            # 房主本机直连服务实现
├── shared/            # 前后端共享协议
├── src/               # React 渲染层
└── package.json
```

## 本地开发

### 安装依赖

```bash
npm install
```

### 启动桌面端开发环境

```bash
npm run dev
```

说明：

- 不再需要额外启动中心服务
- 房主点击 UI 中的“启动本机分享并建房”即可

## 构建

### 构建桌面端和本地直连服务产物

```bash
npm run build
```

### 打包 macOS

```bash
npm run package:mac
```

### 打包 Windows

```bash
npm run package:win
```

## 可选：单独启动房主直连服务

主要用于开发或调试：

```bash
npm run start:server
```

默认监听 `4000` 端口。

## 网络前提

这版默认建立在下面这个前提之上：

- 双方已经通过局域网或虚拟局域网互通
- 双方可以直接访问对方机器的内网/VPN 地址

如果双方不在同一张可互通网络里，这版不会自动做 NAT 打洞或 TURN 中继。

## 当前限制

- 当前只支持两人房间
- 房主导入视频时，当前实现会复制一份到房主本机直连服务目录
- 对超大视频文件，房主本机磁盘和 IO 会有额外开销
- 还没有字幕同步、语音通话、断点续传导入
- 还没有 NAT 穿透能力，前提是双方网络已经互通

## 下一步建议

1. 把“房主导入视频”从本地复制改成直接挂载源文件，减少磁盘占用
2. 增加字幕文件同步
3. 增加语音通话
4. 增加房主网卡/分享地址选择器
5. 增加真正的 WebRTC 打洞模式，覆盖非局域网场景

## Git

当前开发分支是 `codex/watchtogether-mvp`。
